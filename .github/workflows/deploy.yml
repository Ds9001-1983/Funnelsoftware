name: Deploy to Production

on:
  push:
    branches:
      - main
      - claude/funnel-drag-drop-builder-201GU
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Hetzner Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd /var/www/funnelflow

            # Pull latest code
            git fetch origin
            git reset --hard origin/${{ github.ref_name }}

            # Install dependencies
            npm ci

            # Build the application
            npm run build

            # Run database migrations (without --force to preserve data)
            # Only run if schema changed, skip errors for existing tables
            npx drizzle-kit push 2>/dev/null || echo "Schema already up to date"

            # Restart PM2
            pm2 restart funnelflow || pm2 start dist/index.cjs --name funnelflow

            # Save PM2 config
            pm2 save

            echo "Deployment completed successfully!"
